<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Do or Die | DOD</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Teko:wght@300..700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByLeOnstoCGQ9vew1NYXtBe2E_xyUVgDg",
            authDomain: "do-or-die-33610.firebaseapp.com",
            databaseURL: "https://do-or-die-33610-default-rtdb.firebaseio.com",
            projectId: "do-or-die-33610",
            storageBucket: "do-or-die-33610.firebasestorage.app",
            messagingSenderId: "816098304473",
            appId: "1:816098304473:web:4e48a2004ccbe70db0b9c8",
            measurementId: "G-V9K09W36L9"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.auth = getAuth(app);
        window.ref = ref;
        window.set = set;
        window.update = update;
        window.onValue = onValue;
        window.get = get;
        window.signInAnonymously = signInAnonymously;
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dodPurple: '#A855F7', // Raghendh
                        dodGreen: '#22C55E',  // Devanandh
                        dodBg: '#000000',
                        dodCard: '#0B192C',
                        dodInput: '#1E3E62',
                        dodText: '#e5e7eb',
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                        teko: ['Teko', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(255, 255, 255, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000000; color: #E6E1E5; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        input, select, button, textarea { outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const getTodayDateString = () => {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- COMPONENTS ---

        const SetupScreen = ({ error }) => (
            <div className="min-h-screen bg-dodBg flex flex-col items-center justify-center p-6 text-center">
                <i className="ph-fill ph-warning text-5xl text-dodPurple mb-4"></i>
                <h1 className="text-3xl font-medium text-white mb-2">Connection Issue</h1>
                <p className="text-gray-400 mb-6 text-sm">{error?.message || "Could not connect to Firebase."}</p>
            </div>
        );

        // 1. SMOOTH MORPHING STOPWATCH
        const Stopwatch = ({ label, theme, progress }) => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const timerRef = useRef(null);

            const toggle = () => {
                if (isRunning) {
                    clearInterval(timerRef.current);
                    setIsRunning(false);
                    setTime(0);
                } else {
                    const startTime = Date.now() - time;
                    timerRef.current = setInterval(() => {
                        setTime(Date.now() - startTime);
                    }, 100);
                    setIsRunning(true);
                }
            };

            const format = (ms) => {
                const mins = Math.floor(ms / 60000).toString().padStart(2, '0');
                const secs = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            };
            
            const decis = Math.floor((time % 1000) / 100);

            // Interpolation Helpers
            const p = Math.min(Math.max(progress, 0), 1); // Clamp 0-1
            
            // Dynamic Styles based on scroll progress
            const cardBg = theme === 'purple' 
                ? `linear-gradient(145deg, #A855F7 ${100 - p*50}%, #6b21a8)` 
                : `linear-gradient(145deg, #22C55E ${100 - p*50}%, #14532d)`;
            
            // Tuned Sizes: TEKO is condensed, so we make sizes HUGE for impact
            // Start: 5.5rem time, End: 3rem time
            const fontSizeTime = 5.5 - (p * 2.5); 
            const fontSizeDecis = 2.5 - (p * 1.5); // Hides decimal
            const paddingY = 1 - (p * 0.5); 
            
            // Name label size: Start 2.5rem, End 1.5rem
            const labelSize = 2.5 - (p * 1);

            return (
                <div 
                    onClick={toggle} 
                    className="flex-1 mx-1 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-transform active:scale-95 shadow-xl overflow-hidden relative border border-white/20 group"
                    style={{
                        background: cardBg,
                        paddingTop: `${Math.max(0.5, paddingY)}rem`,
                        paddingBottom: `${Math.max(0.5, paddingY)}rem`,
                        boxShadow: 'inset 0 0 20px rgba(0,0,0,0.2)'
                    }}
                >
                    <span className="font-teko font-bold tracking-wide uppercase mb-0 text-white/90 leading-none drop-shadow-md" style={{ fontSize: `${labelSize}rem` }}>
                        {label}
                    </span>
                    
                    <div className="font-teko font-medium tracking-tight tabular-nums flex items-baseline text-white leading-none mt-0 drop-shadow-lg" style={{ fontSize: `${fontSizeTime}rem` }}>
                        {format(time)}
                        <span className="font-light text-white/60" style={{ fontSize: `${Math.max(0, fontSizeDecis)}rem`, width: p > 0.5 ? 0 : 'auto' }}>.{decis}</span>
                    </div>
                </div>
            );
        };

        // 2. EXERCISE ROW
        const ExerciseRow = ({ exercise, exIndex, updateExercise, deleteExercise, suggestionList, isExpanded, onToggleExpand, userKey, allHistory, themeBg, themeBorder }) => {
            const [showRemark, setShowRemark] = useState(!!exercise.remark);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showNotesHistory, setShowNotesHistory] = useState(false);
            
            const filteredSuggestions = useMemo(() => {
                if (!exercise.name) return suggestionList.slice(0, 5); 
                const lowerInput = exercise.name.toLowerCase();
                return suggestionList.filter(s => s.toLowerCase().includes(lowerInput)).slice(0, 5);
            }, [exercise.name, suggestionList]);

            const pastNotes = useMemo(() => {
                if(!showNotesHistory || !allHistory || !exercise.name) return [];
                const notes = [];
                Object.entries(allHistory).forEach(([date, dayData]) => {
                    const uData = dayData[userKey];
                    if(uData && uData.exercises) {
                        uData.exercises.forEach(ex => {
                            if(ex.name === exercise.name && ex.remark) notes.push({date, remark: ex.remark});
                        });
                    }
                });
                return notes.sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [showNotesHistory, allHistory, exercise.name, userKey]);

            const addSet = () => updateExercise(exIndex, { ...exercise, sets: [...(exercise.sets || []), { weight: '', reps: '', uni: false }] });
            const updateSet = (sIndex, field, value) => {
                const newSets = [...exercise.sets];
                newSets[sIndex][field] = value;
                updateExercise(exIndex, { ...exercise, sets: newSets });
            };
            const removeSet = (sIndex) => updateExercise(exIndex, { ...exercise, sets: exercise.sets.filter((_, i) => i !== sIndex) });
            const handleNameSelect = (name) => { updateExercise(exIndex, { ...exercise, name: name }); setShowSuggestions(false); };

            // COLLAPSED
            if (!isExpanded) {
                return (
                    <div onClick={onToggleExpand} className={`mb-3 rounded-xl p-4 border cursor-pointer flex justify-between items-center shadow-lg transition-colors ${themeBg} ${themeBorder} bg-opacity-20 hover:bg-opacity-30`}>
                        <div>
                            <h3 className="text-white font-bold text-lg">{exercise.name || "New Exercise"}</h3>
                            <p className="text-xs text-gray-300 mt-0.5 font-mono">{exercise.sets?.length || 0} Sets</p>
                        </div>
                        <i className="ph-bold ph-caret-down text-white/50 text-xl"></i>
                    </div>
                );
            }

            // EXPANDED
            return (
                <div className={`mb-4 rounded-2xl border overflow-visible shadow-xl fade-in ${themeBg} ${themeBorder} bg-opacity-20`}>
                    <div className="flex justify-between items-center p-4 border-b border-white/10 bg-black/20 rounded-t-2xl cursor-pointer" onClick={onToggleExpand}>
                        <div className="flex-1 mr-4 relative">
                            <div className="relative" onClick={(e) => e.stopPropagation()}>
                                <input 
                                    value={exercise.name}
                                    onChange={(e) => { updateExercise(exIndex, {...exercise, name: e.target.value}); setShowSuggestions(true); }}
                                    onFocus={() => setShowSuggestions(true)}
                                    onBlur={() => setTimeout(() => setShowSuggestions(false), 200)} 
                                    className="w-full bg-transparent text-xl font-bold text-white placeholder-white/30 border-none p-0 focus:ring-0"
                                    placeholder="Exercise Name"
                                    autoComplete="off"
                                />
                                {showSuggestions && filteredSuggestions.length > 0 && (
                                    <ul className="absolute left-0 top-full w-full bg-dodCard border border-dodInput rounded-lg mt-2 shadow-2xl z-50 max-h-48 overflow-y-auto">
                                        {filteredSuggestions.map((suggestion, i) => (
                                            <li key={i} onMouseDown={(e) => { e.preventDefault(); handleNameSelect(suggestion); }} className="px-4 py-3 text-sm text-white hover:bg-white/10 cursor-pointer border-b border-white/5 last:border-0">
                                                {suggestion}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2" onClick={e => e.stopPropagation()}>
                            <button onClick={() => setShowNotesHistory(!showNotesHistory)} className={`p-2 rounded-full ${showNotesHistory ? 'bg-white text-black' : 'text-white/60 hover:bg-white/10'}`}>
                                <i className="ph-bold ph-clock-counter-clockwise text-lg"></i>
                            </button>
                            <button onClick={() => setShowRemark(!showRemark)} className={`p-2 rounded-full ${exercise.remark ? 'bg-white text-black' : 'text-white/60 hover:bg-white/10'}`}>
                                <i className="ph-bold ph-notebook text-lg"></i>
                            </button>
                            <button onClick={() => deleteExercise(exIndex)} className="p-2 text-red-400 hover:bg-red-400/20 rounded-full">
                                <i className="ph-bold ph-trash text-lg"></i>
                            </button>
                            <button onClick={onToggleExpand} className="p-2 text-white/60 rounded-full hover:bg-white/10">
                                <i className="ph-bold ph-caret-up text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    {showNotesHistory && (
                        <div className="bg-black/30 p-4 max-h-40 overflow-y-auto border-b border-white/10">
                            <h4 className="text-xs text-white/50 font-bold mb-2 uppercase tracking-wide">History</h4>
                            {pastNotes.length === 0 ? <p className="text-sm text-white/30 italic">No notes.</p> : 
                                pastNotes.map((n, i) => (
                                    <div key={i} className="mb-2 text-sm text-gray-300 border-l-2 border-white/30 pl-2">
                                        <span className="text-white font-bold text-xs block opacity-70">{n.date}</span>
                                        {n.remark}
                                    </div>
                                ))
                            }
                        </div>
                    )}

                    {showRemark && (
                        <div className="px-4 py-3 bg-black/20 border-b border-white/10">
                            <textarea
                                value={exercise.remark || ""}
                                onChange={(e) => updateExercise(exIndex, {...exercise, remark: e.target.value})}
                                placeholder="Add note..."
                                className="w-full bg-transparent text-sm text-white placeholder-white/30 resize-none h-auto focus:ring-0 border-none p-0"
                                rows="1"
                            />
                        </div>
                    )}
                    
                    <div className="p-4 space-y-3">
                        <div className="flex px-1 text-[10px] font-bold text-white/40 tracking-wider">
                            <div className="w-8 text-center">#</div>
                            <div className="flex-1 pl-2">KG</div>
                            <div className="flex-1 pl-2">REPS</div>
                            <div className="w-12 text-center">UNI</div>
                            <div className="w-8"></div>
                        </div>
                        
                        {(exercise.sets || []).map((set, sIndex) => (
                            <div key={sIndex} className="flex gap-3 items-center">
                                <span className="text-white/40 text-sm w-8 text-center font-mono">{sIndex + 1}</span>
                                <div className="flex-1 relative bg-black/20 rounded-lg border border-white/10 focus-within:border-white/50 transition-colors">
                                    <input type="number" value={set.weight} onChange={(e) => updateSet(sIndex, 'weight', e.target.value)} className="w-full bg-transparent p-2 text-white font-mono text-base border-none focus:ring-0 placeholder-white/10 text-center" placeholder="0" />
                                </div>
                                <div className="flex-1 relative bg-black/20 rounded-lg border border-white/10 focus-within:border-white/50 transition-colors">
                                    <input type="number" value={set.reps} onChange={(e) => updateSet(sIndex, 'reps', e.target.value)} className="w-full bg-transparent p-2 text-white font-mono text-base border-none focus:ring-0 placeholder-white/10 text-center" placeholder="0" />
                                </div>
                                <div className="w-12 flex justify-center">
                                    <button onClick={() => updateSet(sIndex, 'uni', !set.uni)} className={`w-8 h-8 rounded-lg flex items-center justify-center border transition-all ${set.uni ? 'bg-white text-black border-white' : 'bg-transparent border-white/20 text-white/30'}`}>
                                        <span className="text-[10px] font-bold">1</span>
                                    </button>
                                </div>
                                <button onClick={() => removeSet(sIndex)} className="text-white/30 hover:text-red-400 w-8 flex justify-center">
                                    <i className="ph-bold ph-x text-lg"></i>
                                </button>
                            </div>
                        ))}
                        
                        <button onClick={addSet} className="w-full py-3 mt-2 text-sm font-bold text-white bg-white/10 rounded-xl hover:bg-white/20 transition-colors flex items-center justify-center gap-2 ripple">
                            <i className="ph-bold ph-plus"></i> Add Set
                        </button>
                    </div>
                </div>
            );
        };

        // 3. WORKOUT LOGGER
        const WorkoutLogger = ({ userKey, allHistory, themeBg, themeBorder, themeText }) => {
            const [split, setSplit] = useState("");
            const [bodyWeight, setBodyWeight] = useState("");
            const [exercises, setExercises] = useState([]);
            const [status, setStatus] = useState("");
            const [expandedIndex, setExpandedIndex] = useState(0); 
            const date = getTodayDateString();

            const suggestionList = useMemo(() => {
                const historySet = new Set();
                if (allHistory) Object.values(allHistory).forEach(dateObj => { const userData = dateObj[userKey]; if (userData?.exercises) userData.exercises.forEach(e => { if (e.name) historySet.add(e.name); }); });
                return Array.from(historySet).sort();
            }, [allHistory, userKey]);

            useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.onValue(window.ref(window.db, `${date}`), (snapshot) => {
                    const data = snapshot.val() || {};
                    const userData = data[userKey] || {};
                    setSplit(data.split || userData.split || "");
                    setBodyWeight(userData.bodyWeight || "");
                    setExercises(userData.exercises || []);
                    if(userData.exercises?.length === 0) setExpandedIndex(0);
                });
                return () => unsubscribe();
            }, [userKey, date]);

            const updateSharedSplit = (newSplit) => { setSplit(newSplit); window.update(window.ref(window.db, date), { split: newSplit }).catch(console.error); };
            const updatePersonalData = async (updates) => {
                setStatus("Saving...");
                try {
                    let cleanExercises = exercises;
                    if (updates.exercises) cleanExercises = updates.exercises.map(ex => ({...ex, name: ex.name.trim()}));
                    const personalUpdate = {};
                    if(updates.bodyWeight !== undefined) personalUpdate.bodyWeight = updates.bodyWeight;
                    if(updates.exercises !== undefined) personalUpdate.exercises = cleanExercises;
                    if (Object.keys(personalUpdate).length > 0) await window.update(window.ref(window.db, `${date}/${userKey}`), personalUpdate);
                    setStatus("Saved"); setTimeout(() => setStatus(""), 1500);
                } catch (e) { setStatus("Error"); }
            };

            const handleAddExercise = () => {
                const newEx = [...exercises, { name: "", sets: [{weight: '', reps: '', uni: false}] }];
                setExercises(newEx); setExpandedIndex(newEx.length - 1); updatePersonalData({ exercises: newEx });
            };
            const handleUpdateExercise = (index, data) => { const newEx = [...exercises]; newEx[index] = data; setExercises(newEx); updatePersonalData({ exercises: newEx }); };
            const handleDeleteExercise = (index) => { const newEx = exercises.filter((_, i) => i !== index); setExercises(newEx); setExpandedIndex(prev => prev > 0 ? prev - 1 : 0); updatePersonalData({ exercises: newEx }); };

            const splits = ["Push", "Pull", "Legs", "Upper", "Lower", "Full Body", "Cardio", "Arms", "Abs", "Rest"];

            return (
                <div className="pt-2 fade-in">
                    {/* Today's Focus Card - Colorful */}
                    <div className={`p-5 rounded-2xl border mb-6 ${themeBg} ${themeBorder} bg-opacity-20`}>
                        <div className="mb-5">
                            <label className="text-xs font-bold text-white/80 tracking-wider uppercase mb-3 block">Today's focus</label>
                            <div className="flex flex-wrap gap-2">
                                {splits.map(s => (
                                    <button key={s} onClick={() => updateSharedSplit(s)} className={`px-4 py-1.5 rounded-lg text-xs font-bold border transition-all ${split === s ? `bg-white text-black border-white` : 'border-white/10 text-white/50 hover:bg-white/5'}`}>
                                        {s}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-white/80 tracking-wider uppercase mb-2 block">Body Weight</label>
                            <div className="bg-black/20 rounded-lg border border-white/10 focus-within:border-white relative">
                                <input type="number" value={bodyWeight} onChange={(e) => { setBodyWeight(e.target.value); updatePersonalData({bodyWeight: e.target.value}); }} placeholder="0.0" className="w-full bg-transparent p-3 text-white font-mono text-lg border-none focus:ring-0" />
                                <span className="absolute right-3 top-3.5 text-sm text-gray-500">kg</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        {exercises.map((ex, i) => (
                            <ExerciseRow 
                                key={i} exercise={ex} exIndex={i} 
                                updateExercise={handleUpdateExercise} deleteExercise={handleDeleteExercise} 
                                suggestionList={suggestionList} isExpanded={i === expandedIndex} 
                                onToggleExpand={() => setExpandedIndex(i === expandedIndex ? -1 : i)} 
                                userKey={userKey} allHistory={allHistory} 
                                themeBg={themeBg} themeBorder={themeBorder}
                            />
                        ))}
                    </div>

                    <button onClick={handleAddExercise} className={`fixed bottom-20 right-4 h-14 pl-4 pr-6 rounded-2xl bg-white text-black shadow-2xl flex items-center gap-2 font-bold transition-transform active:scale-95 z-40`}>
                        <i className="ph-bold ph-plus text-2xl"></i>
                        <span>New Exercise</span>
                    </button>

                    {status && <div className="fixed bottom-20 left-4 bg-dodInput text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2 fade-in backdrop-blur-md border border-white/10"><i className={`ph-fill ph-check-circle ${themeText}`}></i> {status}</div>}
                </div>
            );
        };

        // 4. HISTORY PAGE
        const HistoryPage = ({ historyData }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [viewRemarks, setViewRemarks] = useState({});
            const [expandedDay, setExpandedDay] = useState(null); 

            const toggleRemark = (id) => setViewRemarks(prev => ({...prev, [id]: !prev[id]}));
            
            // Fixed: Deduplicate names by trimming and ignoring case to organize the list
            const allExerciseNames = useMemo(() => {
                const uniqueNames = new Map();
                if (historyData) {
                    Object.values(historyData).forEach(dateObj => {
                        ['raghendh', 'devanandh'].forEach(u => {
                            dateObj[u]?.exercises?.forEach(e => { 
                                if(e.name) {
                                    const clean = e.name.trim();
                                    const lower = clean.toLowerCase();
                                    
                                    // Store the version that looks best (Capitalized over lowercase)
                                    if (!uniqueNames.has(lower)) {
                                        uniqueNames.set(lower, clean);
                                    } else {
                                        // If existing is lower and new is Capitalized, update it to look nicer
                                        const existing = uniqueNames.get(lower);
                                        if (existing[0] === existing[0].toLowerCase() && clean[0] === clean[0].toUpperCase()) {
                                            uniqueNames.set(lower, clean);
                                        }
                                    }
                                }
                            });
                        });
                    });
                }
                return Array.from(uniqueNames.values()).sort();
            }, [historyData]);

            const dates = Object.keys(historyData || {}).sort().reverse();
            
            const searchResults = useMemo(() => {
                if (!searchTerm) return null;
                // Trim search term to ensure trailing spaces don't break matches
                const term = searchTerm.trim().toLowerCase();
                if (!term) return null;

                const res = { raghendh: [], devanandh: [] };
                dates.forEach(date => {
                    const dayData = historyData[date];
                    ['raghendh', 'devanandh'].forEach(u => {
                        if (dayData[u]?.exercises) {
                            dayData[u].exercises.forEach(ex => { 
                                // Robust matching: trim both source and term
                                if (ex.name && ex.name.trim().toLowerCase().includes(term)) {
                                    res[u].push({ 
                                        date, 
                                        split: dayData.split || dayData[u].split, 
                                        bw: dayData[u].bodyWeight, 
                                        exercise: ex 
                                    }); 
                                }
                            });
                        }
                    });
                });
                return res;
            }, [searchTerm, historyData, dates]);

            return (
                <div className="pb-28 space-y-4 pt-2 fade-in">
                    <div className="bg-dodInput rounded-full h-12 flex items-center px-4 mb-4 mx-1">
                        <i className="ph-bold ph-magnifying-glass text-gray-400 text-xl"></i>
                        <input list="history-search" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search exercises..." className="bg-transparent border-none w-full ml-3 text-white placeholder-gray-500 focus:ring-0 h-full" />
                        {searchTerm && <button onClick={() => setSearchTerm("")}><i className="ph-bold ph-x-circle text-gray-400 text-xl"></i></button>}
                        <datalist id="history-search">{allExerciseNames.map((name, i) => <option key={i} value={name} />)}</datalist>
                    </div>

                    {searchTerm && searchResults && (
                        <div className="grid grid-cols-2 gap-3 px-1">
                            {['raghendh', 'devanandh'].map(u => (
                                <div key={u}>
                                    <div className={`text-xs font-bold uppercase mb-3 tracking-widest text-center pb-1 border-b-2 ${u === 'raghendh' ? 'text-dodPurple border-dodPurple' : 'text-dodGreen border-dodGreen'}`}>{u}</div>
                                    <div className="space-y-3">
                                        {searchResults[u].length === 0 && <div className="text-gray-500 text-xs text-center italic">No records</div>}
                                        {searchResults[u].map((item, i) => {
                                            const id = `${u}-${i}`;
                                            return (
                                                <div key={i} className={`p-3 rounded-xl border border-white/10 ${u === 'raghendh' ? 'bg-dodPurple/20' : 'bg-dodGreen/20'}`}>
                                                    <div className="flex justify-between items-baseline mb-2">
                                                        <span className="text-xs font-bold text-white/50">{item.date}</span>
                                                        {item.bw && <span className="text-[10px] bg-white/10 px-1.5 rounded text-white/70">BW: {item.bw}</span>}
                                                    </div>
                                                    <div className="space-y-1">
                                                        {item.exercise.sets?.map((set, si) => (
                                                            <div key={si} className="text-base font-bold text-white font-mono flex justify-between">
                                                                <span>{set.weight}kg x {set.reps}</span>
                                                                {set.uni && <span className="text-[9px] text-white bg-white/20 px-1 rounded">UNI</span>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {item.exercise.remark && (
                                                        <div className="mt-2 pt-2 border-t border-white/10">
                                                            <button onClick={() => toggleRemark(id)} className="text-xs flex items-center gap-1 text-white hover:text-gray-300">
                                                                <i className="ph-fill ph-chat-text"></i> {viewRemarks[id] ? "Hide Note" : "Note"}
                                                            </button>
                                                            {viewRemarks[id] && <div className="mt-1 text-xs text-gray-300 italic bg-white/10 p-1 rounded">{item.exercise.remark}</div>}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {!searchTerm && dates.map(dateStr => {
                        const dayData = historyData[dateStr];
                        if (!dayData) return null;
                        const isExpanded = expandedDay === dateStr;
                        const splitName = dayData.split || dayData.raghendh?.split || dayData.devanandh?.split || '-';

                        return (
                            <div key={dateStr} className={`bg-dodCard mx-1 rounded-xl overflow-hidden mb-2 border border-dodInput transition-all ${isExpanded ? 'ring-1 ring-gray-600' : ''}`}>
                                <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-white/5" onClick={() => setExpandedDay(isExpanded ? null : dateStr)}>
                                    <div>
                                        <h3 className="text-base font-bold text-white">{dateStr}</h3>
                                        <p className="text-xs text-dodPurple font-medium uppercase tracking-wider mt-0.5">{splitName}</p>
                                    </div>
                                    <i className={`ph-bold ph-caret-${isExpanded ? 'up' : 'down'} text-gray-400`}></i>
                                </div>

                                {isExpanded && (
                                    <div className="grid grid-cols-2 divide-x divide-dodInput border-t border-dodInput bg-black/20 fade-in">
                                        {['raghendh', 'devanandh'].map(u => {
                                            const uData = dayData[u];
                                            const color = u === 'raghendh' ? 'text-dodPurple' : 'text-dodGreen';
                                            return (
                                                <div key={u} className="p-3">
                                                    <div className={`text-xs font-black uppercase mb-3 tracking-widest ${color}`}>{u}</div>
                                                    {uData?.bodyWeight && <div className="text-xs mb-3 text-white bg-white/10 inline-block px-2 py-0.5 rounded-sm">BW: {uData.bodyWeight}kg</div>}
                                                    
                                                    <div className="space-y-4">
                                                        {(uData?.exercises || []).map((ex, i) => {
                                                            const id = `${dateStr}-${u}-${i}`;
                                                            return (
                                                                <div key={i}>
                                                                    <div className="text-sm font-bold text-white uppercase mb-1 truncate">{ex.name}</div>
                                                                    <div className="space-y-0.5">
                                                                        {(ex.sets || []).map((s, si) => (
                                                                            <div key={si} className="text-base font-mono font-medium text-gray-300 flex justify-between items-center pr-1">
                                                                                <span>{s.weight}kg x {s.reps}</span>
                                                                                {s.uni && <span className="text-[8px] text-white border border-white px-0.5 rounded">U</span>}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                    {ex.remark && (
                                                                        <button onClick={() => toggleRemark(id)} className="mt-1 text-xs text-white/70 hover:text-white flex items-center gap-1">
                                                                            <i className="ph-fill ph-note"></i> Note
                                                                        </button>
                                                                    )}
                                                                    {viewRemarks[id] && <div className="text-xs text-gray-400 italic mt-1 pl-2 border-l-2 border-white/20">{ex.remark}</div>}
                                                                </div>
                                                            );
                                                        })}
                                                        {!uData?.exercises && <div className="text-xs text-gray-600 italic">Rest Day</div>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );
        };

        // 5. LIBRARY PAGE (Fixed Duplicates)
        const LibraryPage = ({ historyData }) => {
            const [selectedSplit, setSelectedSplit] = useState("Push");
            const splits = ["Push", "Pull", "Legs", "Upper", "Lower", "Full Body", "Cardio", "Arms", "Abs"];
            const exercises = useMemo(() => {
                const uniqueSet = new Set();
                const displayList = [];
                
                if(historyData) {
                    Object.values(historyData).forEach(day => {
                        // Check multiple possible split locations
                        const daySplit = day.split || day.raghendh?.split || day.devanandh?.split;
                        if(daySplit === selectedSplit) {
                            ['raghendh', 'devanandh'].forEach(u => {
                                if(day[u]?.exercises) {
                                    day[u].exercises.forEach(e => { 
                                        if(e.name) {
                                            const clean = e.name.trim();
                                            const lower = clean.toLowerCase();
                                            if(!uniqueSet.has(lower)) {
                                                uniqueSet.add(lower);
                                                displayList.push(clean);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                return displayList.sort();
            }, [historyData, selectedSplit]);

            return (
                <div className="pb-28 pt-2 px-1 fade-in">
                    <h2 className="text-xl font-medium text-white mb-4 ml-1">Exercise Library</h2>
                    <div className="flex flex-wrap gap-2 mb-6">
                        {splits.map(s => (
                            <button key={s} onClick={() => setSelectedSplit(s)} className={`px-4 py-1.5 rounded-lg text-sm font-medium border transition-all ${selectedSplit === s ? 'bg-dodPurple border-dodPurple text-white' : 'bg-transparent border-white/20 text-gray-400'}`}>
                                {s}
                            </button>
                        ))}
                    </div>
                    
                    <div className="bg-dodCard rounded-xl border border-dodInput p-4 shadow-sm">
                        <h3 className="text-dodPurple text-xs uppercase tracking-widest font-bold mb-4">{selectedSplit} Exercises ({exercises.length})</h3>
                        <div className="space-y-3">
                            {exercises.length === 0 ? <div className="text-gray-500 italic text-sm">No exercises found for this split.</div> : 
                                exercises.map((ex, i) => (
                                    <div key={i} className="py-2 border-b border-dodInput last:border-0 text-sm text-white flex items-center gap-3">
                                        <i className="ph-fill ph-barbell text-dodPurple text-lg"></i> {ex}
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP SHELL ---
        const App = () => {
            const [tab, setTab] = useState("raghendh");
            const [isAuth, setIsAuth] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [allHistory, setAllHistory] = useState(null);
            
            const [scrollP, setScrollP] = useState(0);
            const mainRef = useRef(null);

            // Updated Max Height Calculation
            const maxHeight = 255; 
            const minHeight = 110;
            const heightDiff = maxHeight - minHeight;
            
            // Interaction Tweak: Slower transition
            // We want the shrinking to happen over a longer scroll distance for a smoother feel.
            const transitionDistance = 250; // Pixels of scroll to complete the transition

            const handleScroll = (e) => {
                const p = Math.min(e.target.scrollTop / transitionDistance, 1);
                setScrollP(p);
            };

            useEffect(() => {
                if(!window.auth) return;
                const unsub = window.auth.onAuthStateChanged((user) => {
                    if (user) { setIsAuth(true); window.onValue(window.ref(window.db, '/'), (snapshot) => setAllHistory(snapshot.val())); } 
                    else { window.signInAnonymously(window.auth).catch(err => setAuthError(err)); }
                });
                return () => unsub();
            }, []);

            if (authError) return <SetupScreen error={authError} />;
            if (!isAuth) return (
                <div className="h-screen bg-dodBg flex flex-col items-center justify-center">
                    <h1 className="text-6xl font-black text-white tracking-tighter italic animate-pulse">DOD</h1>
                    <p className="text-dodPurple text-xs font-bold tracking-[0.5em] uppercase mt-2">Loading Gym...</p>
                </div>
            );

            return (
                <div className="max-w-md mx-auto h-screen bg-dodBg relative font-sans text-white overflow-hidden flex flex-col">
                    {/* FIXED HEADER */}
                    <div 
                        className="fixed top-0 max-w-md w-full z-40 bg-dodBg/95 backdrop-blur-sm border-b border-white/5 transition-all duration-300 ease-out"
                        style={{
                            height: `${maxHeight - (scrollP * heightDiff)}px`, // 255 -> 110 (shrinks by 145px total, but over 300px scroll)
                            paddingTop: '1rem',
                            paddingBottom: '0.5rem'
                        }}
                    >
                        {/* Title Section (Fades Out) */}
                        <div 
                            className="px-4 flex items-end justify-between mb-4 overflow-hidden"
                            style={{
                                opacity: 1 - (scrollP * 3), 
                                height: `${Math.max(0, 60 - (scrollP * 120))}px`,
                                marginBottom: `${Math.max(0, 16 - (scrollP * 32))}px`
                            }}
                        >
                            <div>
                                <h1 className="text-5xl font-black text-white leading-none tracking-tighter italic">DOD</h1>
                                <p className="text-dodPurple text-[0.6rem] font-bold tracking-[0.6em] uppercase pl-1">do or die</p>
                            </div>
                            <div className="text-[10px] font-bold text-gray-400 bg-dodInput px-3 py-1 rounded-full border border-dodInput">{getTodayDateString()}</div>
                        </div>
                        
                        {/* Stopwatches (Always Visible, scale down) */}
                        <div className="flex justify-between -mx-1 px-4 h-full">
                            <Stopwatch label="Ragh" theme="purple" progress={scrollP} />
                            <Stopwatch label="Dev" theme="green" progress={scrollP} />
                        </div>
                    </div>

                    {/* SCROLLABLE MAIN CONTAINER */}
                    <main 
                        ref={mainRef}
                        onScroll={handleScroll}
                        className="flex-1 overflow-y-auto no-scrollbar scroll-smooth relative"
                    >
                        {/* Invisible spacer fixed to 320px to remain same as previous state */}
                        <div style={{ height: '320px' }}></div> 

                        {/* CONTENT */}
                        <div className="px-4 pb-32">
                            {tab === 'raghendh' && <WorkoutLogger userKey="raghendh" allHistory={allHistory} themeBg="bg-dodPurple" themeBorder="border-dodPurple" themeText="text-dodPurple" />}
                            {tab === 'devanandh' && <WorkoutLogger userKey="devanandh" allHistory={allHistory} themeBg="bg-dodGreen" themeBorder="border-dodGreen" themeText="text-dodGreen" />}
                            {tab === 'history' && <HistoryPage historyData={allHistory} />}
                            {tab === 'library' && <LibraryPage historyData={allHistory} />}
                        </div>
                    </main>

                    {/* BOTTOM NAVIGATION (Solid Opaque Navy) */}
                    <nav className="absolute bottom-0 w-full bg-dodCard h-14 flex justify-around items-center border-t border-dodInput z-50 shadow-2xl">
                        {[
                            { id: 'raghendh', icon: 'ph-barbell', label: 'Ragh', color: 'dodPurple' },
                            { id: 'devanandh', icon: 'ph-sneaker-move', label: 'Dev', color: 'dodGreen' },
                            { id: 'history', icon: 'ph-clock-counter-clockwise', label: 'History', color: 'white' },
                            { id: 'library', icon: 'ph-books', label: 'Library', color: 'white' }
                        ].map(item => {
                            const isActive = tab === item.id;
                            const activeClass = item.id === 'raghendh' ? 'text-dodPurple' : item.id === 'devanandh' ? 'text-dodGreen' : 'text-white';
                            
                            return (
                                <button key={item.id} onClick={() => setTab(item.id)} className="flex flex-col items-center justify-center w-16 group">
                                    <div className={`transition-all duration-200 ${isActive ? activeClass : 'text-gray-500 group-hover:text-gray-300'}`}>
                                        <i className={`${isActive ? 'ph-fill' : 'ph-bold'} ${item.icon} text-2xl`}></i>
                                    </div>
                                    <span className={`text-[9px] font-bold mt-0.5 ${isActive ? activeClass : 'text-gray-600'}`}>{item.label}</span>
                                </button>
                            );
                        })}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
        }
    </script>
</body>
</html>
