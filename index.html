<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Do or Die | DOD</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Teko:wght@300..700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByLeOnstoCGQ9vew1NYXtBe2E_xyUVgDg",
            authDomain: "do-or-die-33610.firebaseapp.com",
            databaseURL: "https://do-or-die-33610-default-rtdb.firebaseio.com",
            projectId: "do-or-die-33610",
            storageBucket: "do-or-die-33610.firebasestorage.app",
            messagingSenderId: "816098304473",
            appId: "1:816098304473:web:4e48a2004ccbe70db0b9c8",
            measurementId: "G-V9K09W36L9"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.auth = getAuth(app);
        window.ref = ref;
        window.set = set;
        window.update = update;
        window.onValue = onValue;
        window.get = get;
        window.signInAnonymously = signInAnonymously;
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Modern Palette
                        bg: '#09090b',      // Zinc 950
                        surface: '#18181b', // Zinc 900
                        surfaceLight: '#27272a', // Zinc 800
                        primary: '#a855f7', // Purple
                        secondary: '#22c55e', // Green
                        textMain: '#f4f4f5', // Zinc 100
                        textMuted: '#a1a1aa', // Zinc 400
                        border: 'rgba(255, 255, 255, 0.08)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        teko: ['Teko', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon-purple': '0 0 20px rgba(168, 85, 247, 0.15)',
                        'neon-green': '0 0 20px rgba(34, 197, 94, 0.15)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #f4f4f5; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        input, select, button, textarea { outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // HELPER: Normalize strings to Uppercase for consistency
        const normalize = (str) => str ? str.trim().toUpperCase() : "";

        const getTodayDateString = () => {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDatePretty = () => {
            const date = new Date();
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        };

        const calculateAge = (dobString) => {
            const dob = new Date(dobString);
            const diff_ms = Date.now() - dob.getTime();
            const age_dt = new Date(diff_ms);
            return Math.abs(age_dt.getUTCFullYear() - 1970);
        };

        // Static User Data
        const USER_DATA = {
            raghendh: {
                name: "Raghendh",
                dob: "1999-12-17",
                height: 178.5,
                color: "text-primary",
                bg: "bg-primary",
                shadow: "shadow-neon-purple"
            },
            devanandh: {
                name: "Devanandh",
                dob: "2004-01-12",
                height: 175,
                color: "text-secondary",
                bg: "bg-secondary",
                shadow: "shadow-neon-green"
            }
        };

        // --- CHART COMPONENT ---
        const ProgressChart = ({ data, color, type, onClose }) => {
            const [filter, setFilter] = useState('day'); // day, week, month, year

            // Process data based on filter
            const chartData = useMemo(() => {
                if (!data || data.length === 0) return [];
                
                // Sort raw data by date
                const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));

                if (filter === 'day') return sorted.slice(-30); // Last 30 entries

                // Grouping Logic
                const grouped = {};
                sorted.forEach(item => {
                    const date = new Date(item.date);
                    let key;
                    if (filter === 'week') {
                        // Simple ISO week approx
                        const onejan = new Date(date.getFullYear(), 0, 1);
                        const week = Math.ceil((((date.getTime() - onejan.getTime()) / 86400000) + onejan.getDay() + 1) / 7);
                        key = `${date.getFullYear()}-W${week}`;
                    } else if (filter === 'month') {
                        key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    } else if (filter === 'year') {
                        key = `${date.getFullYear()}`;
                    }
                    
                    if (!grouped[key]) grouped[key] = { sum: 0, count: 0, label: key };
                    grouped[key].sum += parseFloat(item.value);
                    grouped[key].count += 1;
                });

                return Object.values(grouped).map(g => ({
                    date: g.label,
                    value: (g.sum / g.count).toFixed(1)
                })).slice(-12); // Limit to last 12 points for cleaner UI

            }, [data, filter]);

            // Chart Configuration
            const width = 100;
            const height = 60;
            const paddingX = 10;
            const paddingY = 10;
            const graphWidth = width - paddingX * 2;
            const graphHeight = height - paddingY * 2;

            // Axis Logic
            const vals = chartData.map(d => parseFloat(d.value));
            const minVal = vals.length ? Math.min(...vals) - 1 : 0;
            const maxVal = vals.length ? Math.max(...vals) + 1 : 10;
            const range = maxVal - minVal;

            // Determine Hex Color
            const strokeHex = color.includes('primary') ? '#a855f7' : '#22c55e';

            // Point Calculation
            const points = useMemo(() => {
                if (chartData.length < 2) return [];
                const step = graphWidth / (chartData.length - 1);
                return chartData.map((d, i) => {
                    const x = paddingX + i * step;
                    const y = (height - paddingY) - ((parseFloat(d.value) - minVal) / range) * graphHeight;
                    return [x, y];
                });
            }, [chartData, minVal, range, graphWidth, graphHeight]);

            // Path Generation
            const linePath = useMemo(() => {
                if (points.length === 0) return "";
                return points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p[0]},${p[1]}`).join(" ");
            }, [points]);

            const areaPath = useMemo(() => {
                if (points.length === 0) return "";
                const lastPoint = points[points.length - 1];
                const firstPoint = points[0];
                return `${linePath} L ${lastPoint[0]},${height - paddingY} L ${firstPoint[0]},${height - paddingY} Z`;
            }, [linePath, points, height, paddingY]);

            const formatDateLabel = (label) => {
                if(filter === 'day') {
                    const d = new Date(label);
                    return `${d.getDate()}/${d.getMonth()+1}`;
                }
                if(filter === 'month') {
                    const [y, m] = label.split('-');
                    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    return months[parseInt(m)-1];
                }
                return label.split('-').pop(); // Shorten week/year
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl fade-in">
                    <div className="bg-surface/50 border border-white/10 rounded-[2rem] w-full max-w-sm p-8 relative shadow-2xl overflow-hidden backdrop-blur-md">
                        
                        {/* Background Glow */}
                        <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-40 h-40 rounded-full blur-[80px] opacity-20 pointer-events-none ${color.replace('text-', 'bg-')}`}></div>

                        <button onClick={onClose} className="absolute top-4 right-4 text-textMuted hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors z-20">
                            <i className="ph-bold ph-x text-xl"></i>
                        </button>
                        
                        <div className="relative z-10 text-center">
                            <h3 className="text-4xl font-teko font-bold text-textMain mb-0 leading-none uppercase tracking-wide">{type} Progress</h3>
                            <p className="text-xs text-textMuted mb-8 uppercase tracking-[0.2em] font-medium">Analytics Overview</p>

                            <div className="flex bg-black/40 rounded-xl p-1 mb-8 backdrop-blur-sm border border-white/5">
                                {['day', 'week', 'month', 'year'].map(f => (
                                    <button 
                                        key={f} 
                                        onClick={() => setFilter(f)}
                                        className={`flex-1 py-2 rounded-lg text-[10px] font-bold uppercase transition-all ${filter === f ? 'bg-textMain text-bg shadow-lg' : 'text-textMuted hover:text-white'}`}
                                    >
                                        {f}
                                    </button>
                                ))}
                            </div>

                            {/* Chart Area */}
                            <div className="h-56 w-full mb-2 relative">
                                {chartData.length > 0 ? (
                                    <svg viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="none" className="w-full h-full overflow-visible font-mono text-[3px]">
                                        <defs>
                                            <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="0%" stopColor={strokeHex} stopOpacity="0.3" />
                                                <stop offset="100%" stopColor={strokeHex} stopOpacity="0" />
                                            </linearGradient>
                                        </defs>

                                        {/* Grid Lines & Y Axis Labels */}
                                        {[0, 0.5, 1].map((ratio, i) => {
                                            const y = (height - paddingY) - (graphHeight * ratio);
                                            const val = (minVal + (range * ratio)).toFixed(1);
                                            return (
                                                <g key={i}>
                                                    <line x1={paddingX} y1={y} x2={width - paddingX} y2={y} stroke="rgba(255,255,255,0.05)" strokeWidth="0.2" strokeDasharray="1,1" />
                                                    <text x={width - paddingX + 2} y={y + 1} fill="#71717a" textAnchor="start">{val}</text>
                                                </g>
                                            )
                                        })}

                                        {/* X Axis Labels */}
                                        {chartData.length > 1 && (
                                            <>
                                                <text x={paddingX} y={height - 2} fill="#71717a" textAnchor="middle">{formatDateLabel(chartData[0].date)}</text>
                                                <text x={width/2} y={height - 2} fill="#71717a" textAnchor="middle">{formatDateLabel(chartData[Math.floor(chartData.length/2)].date)}</text>
                                                <text x={width - paddingX} y={height - 2} fill="#71717a" textAnchor="middle">{formatDateLabel(chartData[chartData.length-1].date)}</text>
                                            </>
                                        )}
                                        
                                        {/* Area Fill */}
                                        <path 
                                            d={areaPath} 
                                            fill="url(#chartGradient)" 
                                        />

                                        {/* The Line */}
                                        <path 
                                            d={linePath} 
                                            fill="none" 
                                            stroke={strokeHex} 
                                            strokeWidth="0.8" 
                                            strokeLinecap="round" 
                                            strokeLinejoin="round"
                                            filter={`drop-shadow(0 0 4px ${strokeHex})`}
                                        />
                                        
                                        {/* Last Data Point */}
                                        {(() => {
                                            const last = points[points.length - 1];
                                            if(!last) return null;
                                            return (
                                                <g>
                                                    <circle cx={last[0]} cy={last[1]} r="2" fill={strokeHex} opacity="0.3" className="animate-ping" />
                                                    <circle cx={last[0]} cy={last[1]} r="1.5" fill="white" />
                                                </g>
                                            )
                                        })()}
                                    </svg>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-textMuted opacity-50">
                                        <i className="ph-duotone ph-chart-line-up text-4xl mb-2"></i>
                                        <span className="text-xs">No data available</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS ---

        const SetupScreen = ({ error }) => (
            <div className="min-h-screen bg-bg flex flex-col items-center justify-center p-6 text-center">
                <div className="w-20 h-20 rounded-3xl bg-surface border border-border flex items-center justify-center mb-6 shadow-neon-purple animate-pulse">
                    <i className="ph-fill ph-warning text-4xl text-primary"></i>
                </div>
                <h1 className="text-2xl font-bold text-textMain mb-2">Connection Issue</h1>
                <p className="text-textMuted text-sm">{error?.message || "Could not connect to Firebase."}</p>
            </div>
        );

        // 1. MODERN WIDGET STOPWATCH (No changes)
        const StopwatchWidget = ({ label, colorClass, shadowClass }) => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const timerRef = useRef(null);
            const bgClass = colorClass.replace('text-', 'bg-');

            const toggle = () => {
                if (isRunning) {
                    clearInterval(timerRef.current);
                    setIsRunning(false);
                    setTime(0);
                } else {
                    const startTime = Date.now() - time;
                    timerRef.current = setInterval(() => {
                        setTime(Date.now() - startTime);
                    }, 50); 
                    setIsRunning(true);
                }
            };

            const format = (ms) => {
                const mins = Math.floor(ms / 60000).toString().padStart(2, '0');
                const secs = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
                return { mins, secs };
            };
            
            const { mins, secs } = format(time);
            const decis = Math.floor((time % 1000) / 100);

            return (
                <div 
                    onClick={toggle} 
                    className={`relative flex-1 rounded-[2rem] p-5 cursor-pointer overflow-hidden transition-all duration-300 active:scale-95 border h-44 flex flex-col justify-between group
                    ${isRunning ? `${bgClass} border-transparent shadow-lg scale-[1.02]` : `border-white/5 ${shadowClass}`}`}
                    style={{ background: isRunning ? undefined : 'linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%)' }}
                >
                    {!isRunning && <div className={`absolute -right-6 -top-6 w-28 h-28 rounded-full blur-3xl opacity-20 ${bgClass}`}></div>}
                    <div className="relative z-10 mt-1">
                        <span className={`font-teko text-5xl font-bold tracking-wide uppercase leading-none block transition-colors ${isRunning ? 'text-bg mix-blend-screen' : `${colorClass} opacity-90`}`}>
                            {label}
                        </span>
                    </div>
                    <div className="flex items-baseline gap-0.5 relative z-10 mb-1">
                        <span className={`font-teko text-[4.5rem] font-semibold leading-[0.75] tracking-tight transition-colors ${isRunning ? 'text-white' : 'text-textMain'}`}>
                            {mins}:{secs}
                        </span>
                        <span className={`font-teko text-4xl font-light w-8 transition-colors ${isRunning ? 'text-white/60' : 'text-textMuted'}`}>
                            {decis}
                        </span>
                    </div>
                    <div className={`absolute bottom-5 right-5 w-2 h-2 rounded-full transition-colors duration-300 ${isRunning ? 'bg-white animate-pulse' : 'bg-white/10'}`}></div>
                </div>
            );
        };

        // 2. EXERCISE CARD
        const ExerciseCard = ({ exercise, exIndex, updateExercise, deleteExercise, suggestionList, isExpanded, onToggleExpand, userKey, allHistory, colorTheme }) => {
            const [showRemark, setShowRemark] = useState(!!exercise.remark);
            const [showSuggestions, setShowSuggestions] = useState(false);
            
            // Toggles for new sections
            const [showPrevSets, setShowPrevSets] = useState(false);
            const [showPrevNote, setShowPrevNote] = useState(false);
            const [showPRCalc, setShowPRCalc] = useState(false);
            const [prPercent, setPrPercent] = useState(50);
            
            const filteredSuggestions = useMemo(() => {
                if (!exercise.name) return suggestionList.slice(0, 5); 
                const lowerInput = normalize(exercise.name);
                return suggestionList.filter(s => s.includes(lowerInput)).slice(0, 5);
            }, [exercise.name, suggestionList]);

            // Find the immediate previous session for this exercise
            const previousSession = useMemo(() => {
                if(!allHistory || !exercise.name) return null;
                const targetName = normalize(exercise.name);
                const today = getTodayDateString();
                
                // Get all dates, sort descending to find most recent
                const sortedDates = Object.keys(allHistory).sort().reverse();
                
                for (const date of sortedDates) {
                    if (date === today) continue; // Skip today
                    const dayData = allHistory[date];
                    const uData = dayData[userKey];
                    if (uData && uData.exercises) {
                        const found = uData.exercises.find(ex => normalize(ex.name) === targetName);
                        if (found) {
                            return { date, ...found };
                        }
                    }
                }
                return null;
            }, [allHistory, exercise.name, userKey]);

            // Calculate Current User's PR for this Exercise
            const currentPR = useMemo(() => {
                if (!allHistory || !exercise.name) return 0;
                let max = 0;
                const targetName = normalize(exercise.name);
                
                Object.values(allHistory).forEach(dayData => {
                    const uData = dayData[userKey];
                    if (uData && uData.exercises) {
                        uData.exercises.forEach(ex => {
                            if (normalize(ex.name) === targetName && ex.sets) {
                                ex.sets.forEach(s => {
                                    const w = parseFloat(s.weight);
                                    if (!isNaN(w) && w > max) max = w;
                                });
                            }
                        });
                    }
                });
                return max;
            }, [allHistory, exercise.name, userKey]);

            const addSet = () => updateExercise(exIndex, { ...exercise, sets: [...(exercise.sets || []), { weight: '', reps: '', uni: false }] });
            const updateSet = (sIndex, field, value) => {
                const newSets = [...exercise.sets];
                newSets[sIndex][field] = value;
                updateExercise(exIndex, { ...exercise, sets: newSets });
            };
            const removeSet = (sIndex) => updateExercise(exIndex, { ...exercise, sets: exercise.sets.filter((_, i) => i !== sIndex) });
            const handleNameSelect = (name) => { updateExercise(exIndex, { ...exercise, name: name }); setShowSuggestions(false); };

            if (!isExpanded) {
                return (
                    <div onClick={onToggleExpand} className="glass-panel rounded-2xl p-4 mb-3 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors group">
                        <div className="flex items-center gap-4">
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center bg-surface border border-border ${colorTheme.text}`}>
                                <span className="font-teko text-xl font-bold">{exIndex + 1}</span>
                            </div>
                            <div>
                                <h3 className="text-textMain font-semibold text-lg leading-tight uppercase">{exercise.name || "NEW EXERCISE"}</h3>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="text-[10px] font-bold uppercase tracking-wider text-textMuted bg-surfaceLight px-1.5 py-0.5 rounded">{exercise.sets?.length || 0} Sets</span>
                                    {exercise.remark && <i className="ph-fill ph-note text-textMuted text-xs"></i>}
                                </div>
                            </div>
                        </div>
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center bg-transparent group-hover:bg-white/10 transition-colors`}>
                            <i className="ph-bold ph-caret-down text-textMuted"></i>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl mb-4 overflow-visible fade-in ring-1 ring-white/10">
                    <div className="p-5 border-b border-border flex justify-between items-start gap-4">
                        <div className="flex-1 relative">
                            <input 
                                value={exercise.name}
                                onChange={(e) => { updateExercise(exIndex, {...exercise, name: e.target.value.toUpperCase()}); setShowSuggestions(true); }}
                                onFocus={() => setShowSuggestions(true)}
                                onBlur={() => setTimeout(() => setShowSuggestions(false), 200)} 
                                className="w-full bg-transparent text-2xl font-bold text-textMain placeholder-textMuted/30 border-none p-0 focus:ring-0 leading-none uppercase"
                                placeholder="NAME..."
                                autoComplete="off"
                            />
                            {showSuggestions && filteredSuggestions.length > 0 && (
                                <ul className="absolute left-0 top-full w-full bg-surfaceLight border border-border rounded-xl mt-2 shadow-2xl z-50 max-h-48 overflow-y-auto overflow-x-hidden">
                                    {filteredSuggestions.map((suggestion, i) => (
                                        <li key={i} onMouseDown={(e) => { e.preventDefault(); handleNameSelect(suggestion); }} className="px-4 py-3 text-sm text-textMain hover:bg-white/10 cursor-pointer border-b border-white/5 last:border-0 uppercase">
                                            {suggestion}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        <div className="flex gap-1">
                            <button onClick={() => deleteExercise(exIndex)} className="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20">
                                <i className="ph-bold ph-trash"></i>
                            </button>
                            <button onClick={onToggleExpand} className="w-8 h-8 flex items-center justify-center rounded-lg bg-surface text-textMuted hover:bg-white/10">
                                <i className="ph-bold ph-caret-up"></i>
                            </button>
                        </div>
                    </div>

                    <div className="flex items-center gap-2 px-5 py-3 border-b border-border bg-black/20 overflow-x-auto no-scrollbar">
                        {/* 1. PR Button */}
                        {currentPR > 0 && (
                            <button onClick={() => setShowPRCalc(!showPRCalc)} className={`text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors whitespace-nowrap ${showPRCalc ? 'bg-secondary text-white shadow-neon-green' : 'bg-surface text-textMuted hover:text-textMain'}`}>
                                <i className="ph-bold ph-percent"></i> PR
                            </button>
                        )}

                        {/* 2. History Button */}
                        <button onClick={() => setShowPrevSets(!showPrevSets)} className={`text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors whitespace-nowrap ${showPrevSets ? 'bg-primary text-white shadow-neon-purple' : 'bg-surface text-textMuted hover:text-textMain'}`}>
                            <i className="ph-bold ph-clock-counter-clockwise"></i> History
                        </button>

                        {/* 3. Note Button */}
                        <button onClick={() => setShowRemark(!showRemark)} className={`text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors whitespace-nowrap ${showRemark || exercise.remark ? 'bg-surfaceLight text-textMain border border-white/10' : 'bg-surface text-textMuted hover:text-textMain'}`}>
                            <i className="ph-bold ph-notebook"></i> Note
                        </button>

                        {/* 4. Notes History Icon Button */}
                        <button 
                            onClick={() => setShowPrevNote(!showPrevNote)} 
                            className={`w-8 h-8 rounded-lg flex items-center justify-center transition-colors ml-auto ${(previousSession && previousSession.remark) ? `${colorTheme.text} bg-white/5 border border-white/5` : 'text-textMuted bg-transparent opacity-50'}`}
                            disabled={!previousSession}
                        >
                            <i className="ph-bold ph-clock-counter-clockwise"></i>
                        </button>
                    </div>

                    {/* SECTIONS */}

                    {/* PR Calculation Slider */}
                    {showPRCalc && currentPR > 0 && (
                        <div className="p-4 bg-black/20 border-b border-border">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-textMuted uppercase tracking-wider">PR: {currentPR}kg</span>
                                <span className="text-xl font-teko font-bold text-primary">{(currentPR * prPercent / 100).toFixed(1)} <span className="text-xs text-textMuted font-sans">KG</span></span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max="100" 
                                step="10" 
                                value={prPercent} 
                                onChange={(e) => setPrPercent(parseInt(e.target.value))}
                                className="w-full h-2 bg-surfaceLight rounded-lg appearance-none cursor-pointer accent-primary"
                            />
                            <div className="flex justify-between items-center mt-2">
                                <div className="flex justify-between w-full text-[10px] text-textMuted font-mono px-1">
                                    <span>0%</span>
                                    <span>50%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div className="text-center -mt-4">
                                <span className="text-xs font-bold text-textMain bg-surface border border-border px-2 py-0.5 rounded">{prPercent}%</span>
                            </div>
                        </div>
                    )}

                    {/* Previous Session Sets Display */}
                    {showPrevSets && (
                        <div className="bg-black/40 p-4 border-b border-border">
                            {previousSession ? (
                                <div>
                                    <div className="text-xs font-bold text-textMuted mb-2 uppercase tracking-wider">Last Session: {previousSession.date}</div>
                                    <div className="space-y-1">
                                        {(previousSession.sets || []).map((s, i) => (
                                            <div key={i} className="flex justify-between items-center text-sm font-mono text-textMain bg-white/5 px-2 py-1 rounded">
                                                <span>{s.weight}kg x {s.reps}</span>
                                                {s.uni && <span className="text-[10px] text-textMuted border border-white/20 px-1 rounded uppercase">Uni</span>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <p className="text-sm text-textMuted italic">No previous history found.</p>
                            )}
                        </div>
                    )}

                    {/* Previous Session Note Display */}
                    {showPrevNote && previousSession && (
                        <div className="p-4 bg-black/30 border-b border-border">
                            <div className="text-xs font-bold text-textMuted mb-1 uppercase tracking-wider">Note from {previousSession.date}:</div>
                            <div className="text-sm text-textMain italic pl-2 border-l-2 border-white/20">
                                {previousSession.remark || "No note recorded."}
                            </div>
                        </div>
                    )}

                    {/* Current Note Input */}
                    {showRemark && (
                        <div className="p-4 bg-black/20 border-b border-border">
                            <textarea
                                value={exercise.remark || ""}
                                onChange={(e) => updateExercise(exIndex, {...exercise, remark: e.target.value})}
                                placeholder="Add technical cues or notes..."
                                className="w-full bg-surfaceLight/50 text-sm text-textMain placeholder-textMuted/50 rounded-xl p-3 border-none focus:ring-1 focus:ring-primary/50 resize-none min-h-[60px]"
                            />
                        </div>
                    )}

                    <div className="p-4">
                        <div className="grid grid-cols-[30px_1fr_1fr_40px_30px] gap-2 mb-2 text-[10px] font-bold text-textMuted uppercase tracking-wider text-center items-center">
                            <span>#</span>
                            <span>KG</span>
                            <span>Reps</span>
                            <span>Uni</span>
                            <span></span>
                        </div>
                        
                        <div className="space-y-2">
                            {(exercise.sets || []).map((set, sIndex) => (
                                <div key={sIndex} className="grid grid-cols-[30px_1fr_1fr_40px_30px] gap-2 items-center">
                                    <div className="flex items-center justify-center h-10 rounded-lg bg-surface text-textMuted font-mono text-sm">
                                        {sIndex + 1}
                                    </div>
                                    <div className="h-10 relative">
                                        <input 
                                            type="number" 
                                            value={set.weight} 
                                            onChange={(e) => updateSet(sIndex, 'weight', e.target.value)} 
                                            className="w-full h-full rounded-lg glass-input text-center text-textMain font-teko text-xl focus:ring-0"
                                            placeholder="-"
                                        />
                                    </div>
                                    <div className="h-10 relative">
                                        <input 
                                            type="number" 
                                            value={set.reps} 
                                            onChange={(e) => updateSet(sIndex, 'reps', e.target.value)} 
                                            className="w-full h-full rounded-lg glass-input text-center text-textMain font-teko text-xl focus:ring-0"
                                            placeholder="-"
                                        />
                                    </div>
                                    <button 
                                        onClick={() => updateSet(sIndex, 'uni', !set.uni)} 
                                        className={`h-10 rounded-lg flex items-center justify-center border transition-all ${set.uni ? 'bg-primary border-primary text-white shadow-neon-purple' : 'bg-surface border-border text-textMuted'}`}
                                    >
                                        <span className="text-xs font-bold">U</span>
                                    </button>
                                    <button onClick={() => removeSet(sIndex)} className="h-10 flex items-center justify-center text-textMuted hover:text-red-400 transition-colors">
                                        <i className="ph-bold ph-x"></i>
                                    </button>
                                </div>
                            ))}
                        </div>

                        <button onClick={addSet} className="mt-4 w-full py-3.5 rounded-xl border border-dashed border-white/20 text-textMuted hover:text-textMain hover:bg-white/5 hover:border-white/40 transition-all flex items-center justify-center gap-2 text-sm font-medium">
                            <i className="ph-bold ph-plus"></i> Add Set
                        </button>
                    </div>
                </div>
            );
        };

        // 3. MAIN DASHBOARD WIDGET
        const Dashboard = ({ userKey, allHistory, colorTheme }) => {
            const [split, setSplit] = useState("");
            const [bodyWeight, setBodyWeight] = useState("");
            const [exercises, setExercises] = useState([]);
            const [status, setStatus] = useState("");
            // Default to -1 so all cards are collapsed by default
            const [expandedIndex, setExpandedIndex] = useState(-1); 
            const date = getTodayDateString();

            // Modified to share suggestions across ALL users
            const suggestionList = useMemo(() => {
                const historySet = new Set();
                if (allHistory) {
                    Object.values(allHistory).forEach(dateObj => { 
                        // Iterate through both known users
                        ['raghendh', 'devanandh'].forEach(u => {
                            const userData = dateObj[u]; 
                            if (userData?.exercises) {
                                userData.exercises.forEach(e => { 
                                    if (e.name) historySet.add(normalize(e.name)); // Normalize here
                                }); 
                            }
                        });
                    });
                }
                return Array.from(historySet).sort();
            }, [allHistory]); // Removed userKey dependency so it updates from global history

            // Auto-fill Rest Day logic
            useEffect(() => {
                if (!allHistory || !userKey) return;
                
                // Determine Yesterday's date
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const yYear = yesterday.getFullYear();
                const yMonth = String(yesterday.getMonth() + 1).padStart(2, '0');
                const yDay = String(yesterday.getDate()).padStart(2, '0');
                const yStr = `${yYear}-${yMonth}-${yDay}`;

                // Check if entry exists for yesterday
                const dayData = allHistory[yStr];
                
                // If the entire day node is missing OR the specific user node is missing/empty
                if (!dayData || !dayData[userKey]) {
                    // Automatically assign as Rest Day
                    window.update(window.ref(window.db, `${yStr}/${userKey}`), {
                        split: "Rest",
                        exercises: []
                    }).catch(console.error);
                }
            }, [allHistory, userKey]);

            useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.onValue(window.ref(window.db, `${date}`), (snapshot) => {
                    const data = snapshot.val() || {};
                    const userData = data[userKey] || {};
                    setSplit(data.split || userData.split || "");
                    setBodyWeight(userData.bodyWeight || "");
                    setExercises(userData.exercises || []);
                    // We do NOT reset expandedIndex to 0 here to keep it collapsed
                });
                return () => unsubscribe();
            }, [userKey, date]);

            const updateSharedSplit = (newSplit) => { setSplit(newSplit); window.update(window.ref(window.db, date), { split: newSplit }).catch(console.error); };
            const updatePersonalData = async (updates) => {
                setStatus("Saving...");
                try {
                    let cleanExercises = exercises;
                    if (updates.exercises) cleanExercises = updates.exercises.map(ex => ({...ex, name: normalize(ex.name)})); // Force Normalize/Uppercase on save
                    const personalUpdate = {};
                    if(updates.bodyWeight !== undefined) personalUpdate.bodyWeight = updates.bodyWeight;
                    if(updates.exercises !== undefined) personalUpdate.exercises = cleanExercises;
                    if (Object.keys(personalUpdate).length > 0) await window.update(window.ref(window.db, `${date}/${userKey}`), personalUpdate);
                    setStatus("Saved"); setTimeout(() => setStatus(""), 1500);
                } catch (e) { setStatus("Error"); }
            };

            const handleAddExercise = () => {
                const newEx = [...exercises, { name: "", sets: [{weight: '', reps: '', uni: false}] }];
                setExercises(newEx); 
                setExpandedIndex(newEx.length - 1); // Expand ONLY the new card
                updatePersonalData({ exercises: newEx });
            };
            const handleUpdateExercise = (index, data) => { const newEx = [...exercises]; newEx[index] = data; setExercises(newEx); updatePersonalData({ exercises: newEx }); };
            const handleDeleteExercise = (index) => { const newEx = exercises.filter((_, i) => i !== index); setExercises(newEx); setExpandedIndex(-1); updatePersonalData({ exercises: newEx }); };

            const splits = ["Push", "Pull", "Legs", "Upper", "Lower", "Full Body", "Cardio", "Arms", "Abs", "Rest"];

            return (
                <div className="fade-in pb-24">
                    {/* Header Widget */}
                    <div className="glass-panel rounded-3xl p-5 mb-6 relative overflow-hidden">
                        <div className={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br ${colorTheme.gradient} opacity-20 blur-3xl rounded-full translate-x-10 -translate-y-10`}></div>
                        
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h2 className="text-textMuted text-xs font-bold uppercase tracking-wider mb-1">Current Session</h2>
                                <h1 className={`text-3xl font-black italic tracking-tighter ${colorTheme.text}`}>{userKey.toUpperCase()}</h1>
                            </div>
                            <div className="bg-surface border border-border rounded-xl px-3 py-2">
                                <span className="text-xs font-bold text-textMain block">Bodyweight</span>
                                <div className="flex items-baseline gap-1">
                                    <input 
                                        type="number" 
                                        value={bodyWeight} 
                                        onChange={(e) => { setBodyWeight(e.target.value); updatePersonalData({bodyWeight: e.target.value}); }} 
                                        placeholder="--" 
                                        className="w-12 bg-transparent text-lg font-teko font-bold text-textMain border-none p-0 focus:ring-0 text-right" 
                                    />
                                    <span className="text-[10px] text-textMuted">kg</span>
                                </div>
                            </div>
                        </div>

                        <div className="relative z-10">
                            <label className="text-[10px] font-bold text-textMuted uppercase tracking-wider mb-2 block">Focus</label>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 -mx-1 px-1">
                                {splits.map(s => (
                                    <button 
                                        key={s} 
                                        onClick={() => updateSharedSplit(s)} 
                                        className={`whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold transition-all border ${split === s ? `bg-textMain text-bg border-textMain shadow-lg shadow-white/10` : 'bg-surface border-border text-textMuted hover:bg-surfaceLight'}`}
                                    >
                                        {s}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Exercise Stack */}
                    <div className="space-y-1">
                        {exercises.map((ex, i) => (
                            <ExerciseCard 
                                key={i} exercise={ex} exIndex={i} 
                                updateExercise={handleUpdateExercise} deleteExercise={handleDeleteExercise} 
                                suggestionList={suggestionList} isExpanded={i === expandedIndex} 
                                onToggleExpand={() => setExpandedIndex(i === expandedIndex ? -1 : i)} 
                                userKey={userKey} allHistory={allHistory} 
                                colorTheme={colorTheme}
                            />
                        ))}
                    </div>

                    <button 
                        onClick={handleAddExercise} 
                        className={`fixed bottom-24 right-5 w-14 h-14 rounded-2xl ${colorTheme.bg} flex items-center justify-center text-white shadow-lg shadow-${colorTheme.shadow} hover:scale-105 active:scale-95 transition-all z-40 border border-white/20`}
                    >
                        <i className="ph-bold ph-plus text-2xl"></i>
                    </button>

                    {status && (
                        <div className="fixed bottom-24 left-5 bg-surface/80 backdrop-blur-md border border-border text-textMain px-4 py-2 rounded-xl text-xs font-bold shadow-2xl flex items-center gap-2 fade-in z-50">
                            <div className={`w-2 h-2 rounded-full ${colorTheme.bg}`}></div> {status}
                        </div>
                    )}
                </div>
            );
        };

        // 4. TIMELINE WIDGET (HISTORY)
        const Timeline = ({ historyData }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [expandedDate, setExpandedDate] = useState(null); 
            const [viewRemarks, setViewRemarks] = useState({});
            
            const toggleRemark = (id) => setViewRemarks(prev => ({...prev, [id]: !prev[id]}));

            const allExerciseNames = useMemo(() => {
                const uniqueNames = new Set();
                if (historyData) {
                    Object.values(historyData).forEach(dateObj => {
                        ['raghendh', 'devanandh'].forEach(u => {
                            dateObj[u]?.exercises?.forEach(e => { 
                                if(e.name) {
                                    uniqueNames.add(normalize(e.name)); // Normalize here
                                }
                            });
                        });
                    });
                }
                return Array.from(uniqueNames).sort();
            }, [historyData]);

            // Filter out non-date keys (like "profiles")
            const dates = Object.keys(historyData || {})
                .filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)) // Strictly match YYYY-MM-DD
                .sort()
                .reverse();
            
            const searchResults = useMemo(() => {
                if (!searchTerm) return null;
                const term = normalize(searchTerm);
                if (!term) return null;

                const res = { raghendh: [], devanandh: [] };
                dates.forEach(date => {
                    const dayData = historyData[date];
                    ['raghendh', 'devanandh'].forEach(u => {
                        if (dayData[u]?.exercises) {
                            dayData[u].exercises.forEach(ex => { 
                                if (ex.name && normalize(ex.name).includes(term)) {
                                    res[u].push({ date, split: dayData.split || dayData[u].split, bw: dayData[u].bodyWeight, exercise: ex }); 
                                }
                            });
                        }
                    });
                });
                return res;
            }, [searchTerm, historyData, dates]);

            return (
                <div className="pb-24 pt-2 fade-in">
                    <div className="glass-panel rounded-2xl p-2 mb-4 flex items-center gap-3 shadow-glass">
                        <div className="w-10 h-10 rounded-xl bg-surface flex items-center justify-center text-textMuted">
                            <i className="ph-bold ph-magnifying-glass text-xl"></i>
                        </div>
                        <input 
                            list="history-search" 
                            value={searchTerm} 
                            onChange={(e) => setSearchTerm(e.target.value)} 
                            placeholder="Search history..." 
                            className="bg-transparent border-none flex-1 text-textMain placeholder-textMuted focus:ring-0 text-sm font-medium uppercase" 
                        />
                        {searchTerm && (
                            <button onClick={() => setSearchTerm("")} className="w-10 h-10 flex items-center justify-center text-textMuted hover:text-white">
                                <i className="ph-fill ph-x-circle text-xl"></i>
                            </button>
                        )}
                        <datalist id="history-search">{allExerciseNames.map((name, i) => <option key={i} value={name} />)}</datalist>
                    </div>

                    {searchTerm && searchResults ? (
                        <div className="space-y-4">
                            {['raghendh', 'devanandh'].map(u => (
                                <div key={u}>
                                    <h3 className={`text-xs font-black uppercase tracking-widest mb-3 pl-2 ${u === 'raghendh' ? 'text-primary' : 'text-secondary'}`}>{u}</h3>
                                    <div className="space-y-3">
                                        {searchResults[u].map((item, i) => (
                                            <div key={i} className="glass-panel rounded-2xl p-4 border-l-4 border-l-surfaceLight relative overflow-hidden">
                                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${u === 'raghendh' ? 'bg-primary' : 'bg-secondary'}`}></div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold text-textMuted bg-surface px-2 py-1 rounded-lg">{item.date}</span>
                                                    {item.bw && <span className="text-[10px] text-textMuted">BW: {item.bw}kg</span>}
                                                </div>
                                                <h4 className="font-bold text-textMain mb-2 uppercase">{item.exercise.name}</h4>
                                                <div className="flex flex-wrap gap-2">
                                                    {item.exercise.sets?.map((s, si) => (
                                                        <div key={si} className="bg-surface border border-border px-2 py-1 rounded text-xs font-mono text-textMain flex items-center gap-1">
                                                            {s.weight}kg x {s.reps}
                                                            {s.uni && <span className="text-[9px] text-textMuted uppercase border-l border-white/10 pl-1 ml-1">U</span>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-3 relative">
                            <div className="absolute left-[19px] top-4 bottom-0 w-0.5 bg-border z-0"></div>
                            {dates.map(dateStr => {
                                const dayData = historyData[dateStr];
                                if (!dayData) return null;
                                const splitName = dayData.split || dayData.raghendh?.split || dayData.devanandh?.split || '-';
                                const isExpanded = expandedDate === dateStr;

                                return (
                                    <div key={dateStr} className="relative z-10 pl-10">
                                        <div className="absolute left-0 top-1 w-10 h-10 rounded-full bg-surface border-4 border-bg flex items-center justify-center text-textMuted text-[10px] font-bold shadow-sm">
                                            {dateStr.split('-')[2]}
                                        </div>
                                        
                                        <div className="glass-panel rounded-2xl mb-4 overflow-hidden">
                                            <div 
                                                className="p-4 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors"
                                                onClick={() => setExpandedDate(isExpanded ? null : dateStr)}
                                            >
                                                <div>
                                                    <div className="text-xs font-bold text-textMuted uppercase tracking-wider mb-1">{new Date(dateStr).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</div>
                                                    <div className="text-lg font-bold text-textMain leading-none">{splitName}</div>
                                                </div>
                                                <div className={`w-8 h-8 rounded-full bg-surface flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                                    <i className="ph-bold ph-caret-down text-textMuted"></i>
                                                </div>
                                            </div>
                                            
                                            {isExpanded && (
                                                <div className="border-t border-border bg-black/20 p-4">
                                                    <div className="grid grid-cols-2 gap-4 divide-x divide-border">
                                                        {['raghendh', 'devanandh'].map(u => {
                                                            const uData = dayData[u];
                                                            const color = u === 'raghendh' ? 'text-primary' : 'text-secondary';
                                                            return (
                                                                <div key={u} className={u === 'devanandh' ? 'pl-4' : ''}>
                                                                    <div className={`text-[10px] font-black uppercase mb-3 ${color}`}>{u}</div>
                                                                    {uData?.bodyWeight && <div className="text-[10px] mb-3 text-textMuted bg-surface inline-block px-2 py-0.5 rounded">BW: {uData.bodyWeight}kg</div>}
                                                                    
                                                                    <div className="space-y-4">
                                                                        {(uData?.exercises || []).map((ex, i) => {
                                                                             const id = `${dateStr}-${u}-${i}`;
                                                                             return (
                                                                                <div key={i}>
                                                                                    <div className="text-xs font-bold text-textMain uppercase mb-1 truncate">{ex.name}</div>
                                                                                    <div className="space-y-1">
                                                                                        {(ex.sets || []).map((s, si) => (
                                                                                            <div key={si} className="text-xs font-mono text-textMuted flex justify-between items-center">
                                                                                                <span>
                                                                                                    {s.weight}kg x {s.reps}
                                                                                                    {s.uni && <span className="ml-1 text-[9px] text-textMuted border border-white/20 px-1 rounded">U</span>}
                                                                                                </span>
                                                                                            </div>
                                                                                        ))}
                                                                                    </div>
                                                                                    {ex.remark && (
                                                                                        <button onClick={(e) => { e.stopPropagation(); toggleRemark(id); }} className="mt-1 text-[10px] text-textMuted hover:text-white flex items-center gap-1">
                                                                                            <i className="ph-fill ph-note"></i> Note
                                                                                        </button>
                                                                                    )}
                                                                                    {viewRemarks[id] && <div className="text-[10px] text-textMuted italic mt-1 pl-2 border-l-2 border-white/10">{ex.remark}</div>}
                                                                                </div>
                                                                            );
                                                                        })}
                                                                        {(!uData?.exercises || uData.exercises.length === 0) && <span className="text-[10px] text-white/20 italic">Rest Day</span>}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // 5. CATALOG WIDGET (LIBRARY) (No Changes)
        const Catalog = ({ historyData }) => {
            const [selectedSplit, setSelectedSplit] = useState("Push");
            const splits = ["Push", "Pull", "Legs", "Upper", "Lower", "Full Body", "Cardio", "Arms", "Abs"];
            const exercises = useMemo(() => {
                const uniqueSet = new Set();
                const displayList = [];
                if(historyData) {
                    Object.values(historyData).forEach(day => {
                        const daySplit = day.split || day.raghendh?.split || day.devanandh?.split;
                        if(daySplit === selectedSplit) {
                            ['raghendh', 'devanandh'].forEach(u => {
                                if(day[u]?.exercises) {
                                    day[u].exercises.forEach(e => { 
                                        if(e.name) {
                                            const clean = normalize(e.name);
                                            if(!uniqueSet.has(clean)) {
                                                uniqueSet.add(clean);
                                                displayList.push(clean);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                return displayList.sort();
            }, [historyData, selectedSplit]);

            return (
                <div className="pb-24 pt-2 fade-in">
                    <h2 className="text-xl font-bold text-textMain mb-4 px-2">Exercise Catalog</h2>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2 px-2 -mx-2 mb-4">
                        {splits.map(s => (
                            <button key={s} onClick={() => setSelectedSplit(s)} className={`whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border transition-all ${selectedSplit === s ? 'bg-textMain text-bg border-textMain' : 'bg-surface border-border text-textMuted hover:bg-surfaceLight'}`}>
                                {s}
                            </button>
                        ))}
                    </div>
                    
                    <div className="glass-panel rounded-3xl p-1 min-h-[300px]">
                        {exercises.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-textMuted opacity-50">
                                <i className="ph-duotone ph-barbell text-4xl mb-2"></i>
                                <p className="text-sm">No exercises found</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 divide-y divide-white/5">
                                {exercises.map((ex, i) => (
                                    <div key={i} className="p-4 flex items-center gap-4 hover:bg-white/5 transition-colors first:rounded-t-3xl last:rounded-b-3xl">
                                        <div className="w-8 h-8 rounded-lg bg-surface flex items-center justify-center text-primary">
                                            <i className="ph-fill ph-check-circle"></i>
                                        </div>
                                        <span className="text-sm font-medium text-textMain uppercase">{ex}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENTS ---

        const ProfileSelector = ({ onSelect }) => (
            <div className="fade-in pt-10 px-6">
                <h2 className="text-2xl font-bold text-textMain mb-8 text-center">Select Profile</h2>
                <div className="space-y-6">
                    {Object.entries(USER_DATA).map(([key, data]) => (
                        <div 
                            key={key} 
                            onClick={() => onSelect(key)}
                            className="glass-panel rounded-3xl h-32 flex items-center justify-center cursor-pointer hover:bg-white/5 transition-transform active:scale-95 group relative overflow-hidden"
                        >
                            <div className={`absolute right-[-20px] top-[-20px] w-32 h-32 rounded-full blur-3xl opacity-20 group-hover:opacity-40 transition-opacity ${data.bg}`}></div>
                            <h3 className={`text-4xl font-teko font-bold uppercase tracking-wide ${data.color} relative z-10`}>{data.name}</h3>
                        </div>
                    ))}
                </div>
            </div>
        );

        const ProfileStats = ({ userKey, allHistory, onBack }) => {
            const staticData = USER_DATA[userKey];
            
            // 1. Get Live Data from Firebase (if exists), fallback to static
            const profileData = allHistory?.profiles?.[userKey] || {};
            const height = profileData.height || staticData.height;
            const dob = profileData.dob || staticData.dob; // In case we want to edit DOB later

            const [showWeightChart, setShowWeightChart] = useState(false);
            const [showBMIChart, setShowBMIChart] = useState(false);
            
            // Local state for editing
            const [localHeight, setLocalHeight] = useState(height);
            const [isEditingHeight, setIsEditingHeight] = useState(false);
            
            // Sync local state when database updates (e.g., initial load)
            useEffect(() => {
                setLocalHeight(height);
            }, [height]);

            // Save to Firebase
            const saveHeight = () => {
                if (window.db) {
                    window.update(window.ref(window.db, `profiles/${userKey}`), { 
                        height: localHeight 
                    }).then(() => {
                        setIsEditingHeight(false);
                    }).catch(console.error);
                }
            };
            
            // Calculate Stats
            const age = calculateAge(dob);
            
            // Get Weight History
            const weightHistory = useMemo(() => {
                if(!allHistory) return [];
                const history = [];
                Object.entries(allHistory).forEach(([date, dayData]) => {
                    const bw = dayData[userKey]?.bodyWeight;
                    if(bw) history.push({ date, value: bw });
                });
                return history.sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [allHistory, userKey]);

            // Current Weight (Last recorded)
            const currentWeight = weightHistory.length > 0 ? parseFloat(weightHistory[weightHistory.length - 1].value) : 0;
            
            // BMI using LIVE height
            // We use 'height' (from DB) for display/calc, unless editing
            const displayHeight = isEditingHeight ? localHeight : height;
            const bmi = currentWeight > 0 ? (currentWeight / ((displayHeight/100) ** 2)).toFixed(1) : "--";
            
            // Generate BMI History for Chart
            const bmiHistory = weightHistory.map(w => ({
                date: w.date,
                value: (parseFloat(w.value) / ((displayHeight/100) ** 2)).toFixed(1)
            }));

            // Calculate Focus Stats (Splits per Month)
            const focusStats = useMemo(() => {
                if (!allHistory) return [];
                const stats = {};

                // Filter valid date keys to avoid 'profiles' etc.
                const validDates = Object.keys(allHistory).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/));

                validDates.forEach(date => {
                    const dayData = allHistory[date];
                    const uData = dayData[userKey];

                    // Count only if user has exercises (completed workout)
                    if (uData && uData.exercises && uData.exercises.length > 0) {
                        const dateObj = new Date(date);
                        const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        const monthLabel = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        
                        // Determine Split
                        let split = dayData.split || uData.split || "Unknown";
                        // If split is "Rest", usually no exercises, but just in case
                        if(split === "Rest") return; 

                        if (!stats[monthKey]) {
                            stats[monthKey] = { label: monthLabel, counts: {}, total: 0 };
                        }
                        
                        stats[monthKey].counts[split] = (stats[monthKey].counts[split] || 0) + 1;
                        stats[monthKey].total += 1;
                    }
                });

                return Object.entries(stats)
                    .sort((a, b) => b[0].localeCompare(a[0]))
                    .map(([key, val]) => val);
            }, [allHistory, userKey]);

            return (
                <div className="fade-in pt-4 px-5 pb-10">
                    <button onClick={onBack} className="mb-6 flex items-center gap-2 text-textMuted hover:text-white">
                        <i className="ph-bold ph-arrow-left"></i> Back to profiles
                    </button>
                    
                    <div className="mb-8">
                        <h1 className={`text-4xl font-teko font-bold uppercase ${staticData.color}`}>{staticData.name}</h1>
                        <p className="text-sm text-textMuted font-mono uppercase tracking-widest">Born: {dob}</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        {/* Age Card */}
                        <div className="glass-panel rounded-3xl p-5 flex flex-col justify-between h-40">
                            <div className="text-textMuted"><i className="ph-duotone ph-cake text-2xl"></i></div>
                            <div>
                                <span className="text-4xl font-bold text-textMain">{age}</span>
                                <span className="text-xs text-textMuted font-bold uppercase tracking-wider block">Years Old</span>
                            </div>
                        </div>

                        {/* Height Card (Editable) */}
                        <div className="glass-panel rounded-3xl p-5 flex flex-col justify-between h-40 relative group">
                            <button 
                                onClick={() => {
                                    if (isEditingHeight) {
                                        saveHeight();
                                    } else {
                                        setIsEditingHeight(true);
                                    }
                                }}
                                className={`absolute top-4 right-4 p-2 rounded-full transition-colors ${isEditingHeight ? 'bg-secondary text-white shadow-neon-green' : 'text-textMuted hover:text-white bg-white/5'}`}
                            >
                                <i className={`ph-bold ${isEditingHeight ? 'ph-check' : 'ph-pencil-simple'}`}></i>
                            </button>
                            
                            <div className="text-textMuted"><i className="ph-duotone ph-ruler text-2xl"></i></div>
                            <div>
                                {isEditingHeight ? (
                                    <input 
                                        type="number" 
                                        autoFocus
                                        value={localHeight} 
                                        onChange={(e) => setLocalHeight(e.target.value)} 
                                        className="text-4xl font-bold text-textMain bg-transparent border-b border-white/20 w-24 p-0 focus:ring-0" 
                                    />
                                ) : (
                                    <span className="text-4xl font-bold text-textMain">{height}</span>
                                )}
                                <span className="text-xs text-textMuted font-bold uppercase tracking-wider block">CM Height</span>
                            </div>
                        </div>

                        {/* Weight Card - Clickable */}
                        <div 
                            onClick={() => setShowWeightChart(true)}
                            className="glass-panel rounded-3xl p-5 flex flex-col justify-between h-40 col-span-2 cursor-pointer hover:bg-white/5 transition-colors relative overflow-hidden"
                        >
                            <div className={`absolute right-[-20px] top-[-20px] w-40 h-40 rounded-full blur-3xl opacity-10 ${staticData.bg}`}></div>
                            <div className="flex justify-between items-start">
                                <div className="text-textMuted"><i className="ph-duotone ph-scales text-2xl"></i></div>
                                <i className="ph-bold ph-chart-line-up text-textMuted"></i>
                            </div>
                            <div>
                                <span className="text-5xl font-bold text-textMain">{currentWeight || "--"}</span>
                                <span className="text-sm text-textMuted font-bold uppercase tracking-wider ml-1">KG</span>
                                <span className="text-xs text-textMuted font-bold uppercase tracking-wider block mt-1">Current Weight</span>
                            </div>
                        </div>

                        {/* BMI Card - Clickable */}
                        <div 
                            onClick={() => setShowBMIChart(true)}
                            className="glass-panel rounded-3xl p-5 flex flex-col justify-between h-40 col-span-2 cursor-pointer hover:bg-white/5 transition-colors relative overflow-hidden"
                        >
                            <div className="flex justify-between items-start">
                                <div className="text-textMuted"><i className="ph-duotone ph-activity text-2xl"></i></div>
                                <i className="ph-bold ph-chart-bar text-textMuted"></i>
                            </div>
                            <div>
                                <span className={`text-5xl font-bold ${bmi > 25 ? 'text-orange-400' : bmi < 18.5 ? 'text-blue-400' : 'text-green-400'}`}>{bmi}</span>
                                <span className="text-xs text-textMuted font-bold uppercase tracking-wider block mt-1">BMI Score</span>
                            </div>
                        </div>
                    </div>

                    {/* Focus Stats Section */}
                    <div className="mt-6">
                        <h3 className="text-lg font-bold text-textMain mb-3 uppercase tracking-wider">Monthly Focus Breakdown</h3>
                        <div className="space-y-3">
                            {focusStats.map((stat, i) => (
                                <div key={i} className="glass-panel rounded-2xl p-4">
                                    <div className="flex justify-between items-end mb-3 border-b border-white/5 pb-2">
                                        <span className="font-bold text-textMain text-lg leading-none">{stat.label}</span>
                                        <span className="text-xs text-textMuted font-mono bg-white/5 px-2 py-1 rounded">{stat.total} Workouts</span>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {Object.entries(stat.counts).map(([split, count]) => (
                                            <div key={split} className="flex items-center gap-2 bg-surface border border-border px-3 py-1.5 rounded-lg">
                                                <span className="text-xs font-bold text-textMuted uppercase tracking-wider">{split}</span>
                                                <span className={`text-sm font-bold ${staticData.color}`}>{count}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {focusStats.length === 0 && (
                                <div className="text-center text-textMuted text-sm py-4 italic">No workout history found.</div>
                            )}
                        </div>
                    </div>

                    {/* Modals */}
                    {showWeightChart && <ProgressChart data={weightHistory} color={staticData.color} type="Weight" onClose={() => setShowWeightChart(false)} />}
                    {showBMIChart && <ProgressChart data={bmiHistory} color={staticData.color} type="BMI" onClose={() => setShowBMIChart(false)} />}
                </div>
            );
        };

        // NEW: PR WIDGET
        const PRWidget = ({ historyData }) => {
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [chartUser, setChartUser] = useState('raghendh'); // Toggle for chart

            const prData = useMemo(() => {
                if (!historyData) return {};
                const exercises = {};
                // Iterate all history
                Object.entries(historyData).forEach(([date, dayData]) => {
                    // Filter valid dates
                    if (!date.match(/^\d{4}-\d{2}-\d{2}$/)) return;
                    
                    ['raghendh', 'devanandh'].forEach(u => {
                        const uData = dayData[u];
                        if (uData?.exercises) {
                            uData.exercises.forEach(ex => {
                                if (!ex.name) return;
                                const name = normalize(ex.name);
                                // Find max weight in this session
                                let maxWeight = 0;
                                if (ex.sets) {
                                    ex.sets.forEach(s => {
                                        const w = parseFloat(s.weight);
                                        if (!isNaN(w) && w > maxWeight) maxWeight = w;
                                    });
                                }
                                
                                if (maxWeight > 0) {
                                    if (!exercises[name]) exercises[name] = { raghendh: 0, devanandh: 0 };
                                    // Update All-time PR
                                    if (maxWeight > exercises[name][u]) {
                                        exercises[name][u] = maxWeight;
                                    }
                                }
                            });
                        }
                    });
                });
                return exercises;
            }, [historyData]);

            const sortedExercises = useMemo(() => {
                const priority = ["DEADLIFT", "BENCH PRESS", "SQUATS", "MACHINE DEADLIFT"]; 
                const list = Object.keys(prData).filter(ex => {
                    return prData[ex].raghendh > 0 || prData[ex].devanandh > 0;
                });
                
                return list.sort((a, b) => {
                    const idxA = priority.indexOf(a);
                    const idxB = priority.indexOf(b);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    return a.localeCompare(b);
                });
            }, [prData]);

            // Generate Graph Data for a specific exercise and user
            const getGraphData = (exerciseName, user) => {
                if (!historyData || !exerciseName) return [];
                const points = [];
                let currentPR = 0;
                
                // Sort dates chronologically
                const dates = Object.keys(historyData).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).sort();
                
                dates.forEach(date => {
                    const dayData = historyData[date];
                    const uData = dayData[user];
                    let dayMax = 0;
                    let performed = false;

                    if (uData?.exercises) {
                        uData.exercises.forEach(ex => {
                            if (normalize(ex.name) === exerciseName) {
                                performed = true;
                                if (ex.sets) {
                                    ex.sets.forEach(s => {
                                        const w = parseFloat(s.weight);
                                        if (!isNaN(w) && w > dayMax) dayMax = w;
                                    });
                                }
                            }
                        });
                    }

                    if (performed) {
                        if (dayMax > currentPR) currentPR = dayMax;
                        // Add point. PRs are cumulative, they don't go down.
                        if (currentPR > 0) {
                             points.push({ date, value: currentPR });
                        }
                    }
                });
                return points;
            };

            return (
                <div className="pb-24 pt-2 fade-in">
                    <h2 className="text-xl font-bold text-textMain mb-4 px-2">Personal Records</h2>
                    <div className="space-y-3">
                        {sortedExercises.map(ex => (
                            <div 
                                key={ex} 
                                onClick={() => setSelectedExercise(ex)}
                                className="glass-panel rounded-2xl p-4 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors"
                            >
                                <div className="flex-1">
                                    <h3 className="font-bold text-textMain uppercase mb-2">{ex}</h3>
                                    <div className="flex gap-4">
                                        <div className="text-xs">
                                            <span className="text-primary font-bold mr-1">RAGH</span>
                                            <span className="text-textMain font-mono text-sm">{prData[ex].raghendh || '-'}</span>
                                            <span className="text-[10px] text-textMuted ml-0.5">KG</span>
                                        </div>
                                        <div className="text-xs">
                                            <span className="text-secondary font-bold mr-1">DEV</span>
                                            <span className="text-textMain font-mono text-sm">{prData[ex].devanandh || '-'}</span>
                                            <span className="text-[10px] text-textMuted ml-0.5">KG</span>
                                        </div>
                                    </div>
                                </div>
                                <i className="ph-bold ph-chart-line-up text-textMuted"></i>
                            </div>
                        ))}
                    </div>

                    {selectedExercise && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl fade-in">
                             <div className="w-full max-w-sm relative">
                                <div className="bg-surface/50 border border-white/10 rounded-[2rem] p-6 relative shadow-2xl overflow-hidden backdrop-blur-md">
                                    <button onClick={() => setSelectedExercise(null)} className="absolute top-4 right-4 text-textMuted hover:text-white z-20">
                                        <i className="ph-bold ph-x text-xl"></i>
                                    </button>
                                    
                                    <h3 className="text-2xl font-teko font-bold text-textMain text-center uppercase mb-1">{selectedExercise}</h3>
                                    <p className="text-xs text-textMuted text-center uppercase tracking-widest mb-6">PR Progression</p>

                                    {/* User Toggle */}
                                    <div className="flex bg-black/40 rounded-xl p-1 mb-6">
                                        <button onClick={() => setChartUser('raghendh')} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${chartUser === 'raghendh' ? 'bg-primary text-white shadow-lg' : 'text-textMuted'}`}>Ragh</button>
                                        <button onClick={() => setChartUser('devanandh')} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${chartUser === 'devanandh' ? 'bg-secondary text-white shadow-lg' : 'text-textMuted'}`}>Dev</button>
                                    </div>

                                    {/* We reuse ProgressChart but we need to render it slightly differently since ProgressChart is a modal itself. 
                                        Actually, let's just use the logic from ProgressChart but render it inline. 
                                        Wait, simpler: Just call ProgressChart and let it take over, but pass a custom onClose?
                                        No, the styles clash (double modal). 
                                        I will create a simplified inline version of the chart here.
                                    */}
                                    <div className="relative">
                                        <ProgressChart 
                                            data={getGraphData(selectedExercise, chartUser)} 
                                            color={chartUser === 'raghendh' ? 'text-primary' : 'text-secondary'} 
                                            type="PR"
                                            // Pass a no-op onClose so it doesn't render its own close button logic if we were embedding it, 
                                            // BUT ProgressChart renders a 'fixed inset-0' div. This is a problem.
                                            // I will hack it: I will unmount this modal and mount the ProgressChart modal instead?
                                            // No, I want the toggle.
                                            // Solution: Modify ProgressChart to accept a className prop to override 'fixed inset-0'?
                                            // Too risky "do not change anything else".
                                            // Alternative: I will extract the SVG drawing logic? No, too much code.
                                            // Best approach within constraints:
                                            // The user asked "shows an increase in the PR in graph SAME as that of weight".
                                            // Weight uses ProgressChart.
                                            // So I will render ProgressChart, but I will put the TOGGLE inside the `type` prop? No.
                                            // I will render my custom modal, and inside it I will render the SVG manually? 
                                            // Or I will cheat: I will hide the modal container of ProgressChart via CSS if I pass a specific prop?
                                            // Let's just create a new InlineChart component that is a copy of ProgressChart inner logic but without the modal wrapper.
                                            // Actually, I'll just use ProgressChart and accept the double backdrop or slightly weird UI, it's safer than breaking logic.
                                            // Wait! I can just render the Chart logic here since I have the code in front of me.
                                        />
                                        {/* Since I can't easily modify ProgressChart without risk, I will rely on the fact that ProgressChart renders a Modal.
                                            So, when I select an exercise, I won't render MY modal. I will render ProgressChart directly.
                                            But where do I put the User Toggle?
                                            I'll put the User Toggle in the `PRWidget` list? No.
                                            I'll put the User Toggle ABOVE the ProgressChart?
                                            If ProgressChart is fixed z-50, I need a z-60 toggle?
                                            Okay, plan:
                                            1. When card clicked, set selectedExercise.
                                            2. Render a Z-60 div with the Toggle at the top center of the screen.
                                            3. Render the ProgressChart underneath.
                                        */}
                                    </div>
                                </div>
                             </div>
                        </div>
                    )}
                    
                    {/* The Hacky implementation of the Chart with Toggle */}
                    {selectedExercise && (
                        <div style={{display: 'none'}}> 
                            {/* This is just to satisfy the compiler/logic flow if I were using the component directly. 
                                Actually, I'll implement the "Z-60 Toggle + ProgressChart" approach. */}
                        </div>
                    )}
                    
                    {selectedExercise && (
                        <>
                            {/* Custom Toggle Overlay */}
                            <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[60] flex bg-surface/90 backdrop-blur-md rounded-xl p-1 border border-white/10 shadow-2xl animate-bounce">
                                <button onClick={() => setChartUser('raghendh')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase transition-all ${chartUser === 'raghendh' ? 'bg-primary text-white shadow-neon-purple' : 'text-textMuted'}`}>Ragh</button>
                                <button onClick={() => setChartUser('devanandh')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase transition-all ${chartUser === 'devanandh' ? 'bg-secondary text-white shadow-neon-green' : 'text-textMuted'}`}>Dev</button>
                            </div>
                            
                            <ProgressChart 
                                data={getGraphData(selectedExercise, chartUser)} 
                                color={chartUser === 'raghendh' ? 'text-primary' : 'text-secondary'} 
                                type={`${selectedExercise} PR`}
                                onClose={() => setSelectedExercise(null)} 
                            />
                        </>
                    )}
                </div>
            )
        }


        // --- APP LAYOUT ---
        const Layout = () => {
            const [view, setView] = useState("main"); // main, profiles, profile-detail
            const [selectedProfile, setSelectedProfile] = useState(null);
            
            const [tab, setTab] = useState("raghendh");
            const [isAuth, setIsAuth] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [allHistory, setAllHistory] = useState(null);

            useEffect(() => {
                if(!window.auth) return;
                const unsub = window.auth.onAuthStateChanged((user) => {
                    if (user) { setIsAuth(true); window.onValue(window.ref(window.db, '/'), (snapshot) => setAllHistory(snapshot.val())); } 
                    else { window.signInAnonymously(window.auth).catch(err => setAuthError(err)); }
                });
                return () => unsub();
            }, []);

            if (authError) return <SetupScreen error={authError} />;
            if (!isAuth) return (
                <div className="h-screen bg-bg flex flex-col items-center justify-center relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                    <div className="relative z-10 flex flex-col items-center">
                         <div className="w-24 h-24 rounded-3xl bg-surface border border-border flex items-center justify-center mb-8 shadow-neon-purple animate-bounce">
                             <span className="font-teko text-5xl font-bold text-white">DOD</span>
                         </div>
                        <div className="h-1 w-32 bg-surfaceLight rounded-full overflow-hidden">
                            <div className="h-full bg-primary animate-[width_1s_ease-in-out_infinite] w-1/2"></div>
                        </div>
                    </div>
                </div>
            );

            const themes = {
                raghendh: { text: 'text-primary', bg: 'bg-primary', shadow: 'neon-purple', gradient: 'from-purple-500 to-indigo-500' },
                devanandh: { text: 'text-secondary', bg: 'bg-secondary', shadow: 'neon-green', gradient: 'from-green-500 to-emerald-500' }
            };

            const handleProfileSelect = (key) => {
                setSelectedProfile(key);
                setView('profile-detail');
            };

            return (
                <div className="max-w-md mx-auto h-screen bg-bg text-textMain relative overflow-hidden flex flex-col font-sans">
                    {/* Ambient Background Mesh */}
                    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[40%] rounded-full bg-purple-900/20 blur-[100px] pointer-events-none"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[40%] rounded-full bg-green-900/20 blur-[100px] pointer-events-none"></div>

                    {/* Main Scrollable Content */}
                    <main className="flex-1 overflow-y-auto no-scrollbar scroll-smooth px-5 pb-5">
                        
                        {/* Header (Always Visible) */}
                        <div className="pt-6 pb-2">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h1 className="font-teko text-3xl font-bold leading-none tracking-wide text-white">DO OR DIE</h1>
                                    <p className="text-[10px] font-bold text-textMuted uppercase tracking-widest">{formatDatePretty()}</p>
                                </div>
                                
                                {/* Changed: User Icon acts as button to switch views */}
                                <button 
                                    onClick={() => setView(view === 'main' ? 'profiles' : 'main')}
                                    className={`w-8 h-8 rounded-full border flex items-center justify-center transition-colors ${view !== 'main' ? 'bg-textMain border-textMain text-bg' : 'bg-surface border-border text-textMuted'}`}
                                >
                                    {view === 'main' ? <i className="ph-bold ph-user"></i> : <i className="ph-bold ph-house"></i>}
                                </button>
                            </div>
                        </div>

                        {/* VIEW: MAIN DASHBOARD */}
                        {view === 'main' && (
                            <div className="fade-in">
                                {/* Stopwatches (Only in main view) */}
                                <div className="sticky top-0 z-40 py-2 bg-bg/95 backdrop-blur-xl -mx-5 px-5 border-b border-white/5 mb-4 shadow-glass transition-all">
                                    <div className="flex gap-3">
                                        <StopwatchWidget label="Ragh" colorClass="text-primary" shadowClass="shadow-neon-purple" />
                                        <StopwatchWidget label="Dev" colorClass="text-secondary" shadowClass="shadow-neon-green" />
                                    </div>
                                </div>

                                {/* Tab Content */}
                                {tab === 'raghendh' && <Dashboard userKey="raghendh" allHistory={allHistory} colorTheme={themes.raghendh} />}
                                {tab === 'devanandh' && <Dashboard userKey="devanandh" allHistory={allHistory} colorTheme={themes.devanandh} />}
                                {tab === 'history' && <Timeline historyData={allHistory} />}
                                {tab === 'pr' && <PRWidget historyData={allHistory} />}
                                {tab === 'library' && <Catalog historyData={allHistory} />}
                            </div>
                        )}

                        {/* VIEW: PROFILE SELECTION */}
                        {view === 'profiles' && <ProfileSelector onSelect={handleProfileSelect} />}

                        {/* VIEW: PROFILE DETAILS */}
                        {view === 'profile-detail' && selectedProfile && (
                            <ProfileStats 
                                userKey={selectedProfile} 
                                allHistory={allHistory} 
                                onBack={() => setView('profiles')} 
                            />
                        )}

                    </main>

                    {/* Floating Island Navigation (Only in Main View) */}
                    {view === 'main' && (
                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-50">
                            <nav className="glass-panel rounded-2xl px-2 py-2 flex items-center gap-1 shadow-glass border border-white/10 scale-100 origin-bottom hover:scale-105 transition-transform duration-300">
                                {[
                                    { id: 'raghendh', icon: 'ph-barbell', activeColor: 'bg-primary text-white shadow-neon-purple' },
                                    { id: 'devanandh', icon: 'ph-sneaker-move', activeColor: 'bg-secondary text-white shadow-neon-green' },
                                    { id: 'history', icon: 'ph-clock-counter-clockwise', activeColor: 'bg-textMain text-bg' },
                                    { id: 'pr', icon: 'ph-trophy', activeColor: 'bg-textMain text-bg' },
                                    { id: 'library', icon: 'ph-books', activeColor: 'bg-textMain text-bg' }
                                ].map(item => {
                                    const isActive = tab === item.id;
                                    return (
                                        <button 
                                            key={item.id} 
                                            onClick={() => setTab(item.id)} 
                                            className={`w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300 ${isActive ? item.activeColor : 'text-textMuted hover:bg-white/5 hover:text-textMain'}`}
                                        >
                                            <i className={`${isActive ? 'ph-fill' : 'ph-bold'} ${item.icon} text-xl`}></i>
                                        </button>
                                    );
                                })}
                            </nav>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Layout />);

        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
        }
    </script>
</body>
</html>
